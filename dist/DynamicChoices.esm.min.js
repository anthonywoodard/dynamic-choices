"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=_default;var _choices=_interopRequireDefault(require("choices.js"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){return!call||"object"!==_typeof(call)&&"function"!=typeof call?_assertThisInitialized(self):call}function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),superClass&&_setPrototypeOf(subClass,superClass)}function _wrapNativeSuper(Class){var _cache="function"==typeof Map?new Map:undefined;return(_wrapNativeSuper=function _wrapNativeSuper(Class){if(null===Class||!_isNativeFunction(Class))return Class;if("function"!=typeof Class)throw new TypeError("Super expression must either be null or a function");if(void 0!==_cache){if(_cache.has(Class))return _cache.get(Class);_cache.set(Class,Wrapper)}function Wrapper(){return _construct(Class,arguments,_getPrototypeOf(this).constructor)}return Wrapper.prototype=Object.create(Class.prototype,{constructor:{value:Wrapper,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(Wrapper,Class)})(Class)}function isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _construct(Parent,args,Class){return(_construct=isNativeReflectConstruct()?Reflect.construct:function _construct(Parent,args,Class){var a=[null];a.push.apply(a,args);var instance=new(Function.bind.apply(Parent,a));return Class&&_setPrototypeOf(instance,Class.prototype),instance}).apply(null,arguments)}function _isNativeFunction(fn){return-1!==Function.toString.call(fn).indexOf("[native code]")}function _setPrototypeOf(o,p){return(_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){return o.__proto__=p,o})(o,p)}function _getPrototypeOf(o){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)})(o)}function _default(_ref){var _ref$defaultConfig=_ref.defaultConfig,defaultConfig=void 0===_ref$defaultConfig?{}:_ref$defaultConfig,_ref$paramConfig=_ref.paramConfig,paramConfig=void 0===_ref$paramConfig?{}:_ref$paramConfig,CONFIG_OVERRIDES={noChoicesText:"",shouldSort:!1,searchChoices:!1,removeItemButton:!0,duplicateItemsAllowed:!1},PARAM_CONFIG_DEFAULT={boxId:"",boxClassNames:"",searchButtonId:"",searchButtonTitle:"Search",searchButtonClassNames:"",searchButtonInnerHtml:"Search",clearButtonId:"",clearButtonTitle:"Clear",clearButtonClassNames:"",clearButtonInnerHtml:"Clear",transformValueFnc:!1,apiUrl:"",xhrProgressCallback:!1,searchValue:"id",labelValue:"text",xhrErrorCallback:!1,xhrMethod:"POST",xhrHeaders:[{"Content-type":"application/x-www-form-urlencoded"}],xhrResponseType:"json",xhrQueryKey:"",lookupDelay:300,searchButtonClickCallback:!1,addChoiceCallback:!1,removeItemCallback:!1},config={placeholderValue:"Start typing",itemSelectText:"Press enter to select",classNames:{containerOuter:"choices",containerInner:"choices__inner",listItems:"choices__list--multiple",item:"choices__item",highlightedState:"is-highlighted",button:"choices__button",input:"choices__input",listDropdown:"choices__list--dropdown",itemSelectable:"choices__item--selectable"}};defaultConfig===Object(defaultConfig)?Object.assign(config,defaultConfig,CONFIG_OVERRIDES):Object.assign(config,CONFIG_OVERRIDES),paramConfig=paramConfig===Object(paramConfig)?Object.assign({},PARAM_CONFIG_DEFAULT,paramConfig):PARAM_CONFIG_DEFAULT;var DynamicChoices=function(_HTMLElement){function DynamicChoices(){return _classCallCheck(this,DynamicChoices),_possibleConstructorReturn(this,_getPrototypeOf(DynamicChoices).call(this))}return _inherits(DynamicChoices,_wrapNativeSuper(HTMLElement)),_createClass(DynamicChoices,null,[{key:"observedAttributes",get:function(){return["placeholder-value"]}}]),_createClass(DynamicChoices,[{key:"connectedCallback",value:function(){this._serverLookup=this._serverLookup.bind(this),this._searchEvent=this._searchEvent.bind(this),this._choiceEvent=this._choiceEvent.bind(this),this._searchButtonClick=this._searchButtonClick.bind(this),this._clearButtonClick=this._clearButtonClick.bind(this),this._addItemEvent=this._addItemEvent.bind(this),this._removeItemEvent=this._removeItemEvent.bind(this),this._lookupTimeout=null,this.render();var dc=this.querySelector('[data-hook="DynamicChoices"]');dc.addEventListener("search",this._searchEvent),dc.addEventListener("choice",this._choiceEvent),dc.addEventListener("addItem",this._addItemEvent),dc.addEventListener("removeItem",this._removeItemEvent),this.querySelector('[data-hook="DynamicChoices-search"]').addEventListener("click",this._searchButtonClick),this.querySelector('[data-hook="DynamicChoices-clear"]').addEventListener("click",this._clearButtonClick)}},{key:"render",value:function(){var _this=this;this.innerHTML="\n        <style>\n          .".concat(config.classNames.containerOuter,' {\n            flex: 1 !important;\n            margin-bottom: 0;\n          }\n        </style>\n        <div id="').concat(paramConfig.boxId,'" class="').concat(paramConfig.boxClassNames,'" style="display: flex;">\n          <select data-hook="DynamicChoices" multiple></select>\n          <button id="').concat(paramConfig.clearButtonId,'" title="').concat(paramConfig.clearButtonTitle,'" data-hook="DynamicChoices-clear" class="').concat(paramConfig.clearButtonClassNames,'" style="display:none;">').concat(paramConfig.clearButtonInnerHtml,'</button>\n          <button id="').concat(paramConfig.searchButtonId,'" title="').concat(paramConfig.searchButtonTitle,'" data-hook="DynamicChoices-search" class="').concat(paramConfig.searchButtonClassNames,'">').concat(paramConfig.searchButtonInnerHtml,"</button>\n        </div>"),this._choices=new _choices["default"]('[data-hook="DynamicChoices"]',config),this._choices.input.element.addEventListener("focus",function(e){_this.querySelector(".".concat(config.classNames.listDropdown)).style.display="none"}),this._choices.input.element.addEventListener("keyup",function(e){""!==e.target.value?_this.querySelector(".".concat(config.classNames.listDropdown)).style.display="":_this.querySelector(".".concat(config.classNames.listDropdown)).style.display="none"}),this._choices.input.element.addEventListener("blur",function(e){_this.querySelector(".".concat(config.classNames.listDropdown)).style.display="none"})}},{key:"attributeChangedCallback",value:function(name,oldValue,newValue){"placeholder-value"===name&&this._choices&&this._choices.input.element.setAttribute("placeholder",newValue)}},{key:"disconnectedCallback",value:function(){var dc=this.querySelector('[data-hook="DynamicChoices"]');dc.removeEventListener("search",this._searchEvent),dc.removeEventListener("choice",this._choiceEvent),dc.removeEventListener("addItem",this._addItemEvent),dc.removeEventListener("removeItem",this._removeItemEvent),this.querySelector('[data-hook="DynamicChoices-search"]').removeEventListener("click",this._searchButtonClick),this.querySelector('[data-hook="DynamicChoices-clear"]').removeEventListener("click",this._clearButtonClick),this._choices.destroy()}},{key:"_log",value:function(){var _console;console.group("dynamic-choices"),(_console=console).log.apply(_console,arguments),console.groupEnd()}},{key:"_serverLookup",value:function(val){var _this2=this,query=this._choices.input.value||val||"",apiUrl=this.getAttribute("api-url")||paramConfig.apiUrl,xhrMethod=this.getAttribute("xhr-method")||paramConfig.xhrMethod;if(""===query?this._choices.clearChoices():"function"==typeof paramConfig.transformValueFnc&&(query=paramConfig.transformValueFnc(query)),""!==apiUrl){var xhr=new XMLHttpRequest;"function"==typeof paramConfig.xhrProgressCallback&&xhr.upload.addEventListener("progress",paramConfig.xhrProgressCallback),xhr.onreadystatechange=function(e){if(4===xhr.readyState){var status=xhr.status;if(0===status||200<=status&&status<400){var results=xhr.response,isEmptyResults=!1,searchValue=_this2.getAttribute("search-value")||paramConfig.searchValue,labelValue=_this2.getAttribute("label-value")||paramConfig.labelValue;if(Array.isArray(results)){if(results.map(function(obj){var cp=obj.customProperties={};for(var k in obj)"customProperties"!==k&&(cp[k]=obj[k])}),0===results.length&&(results=[" "],isEmptyResults=!0),val&&!1===isEmptyResults){var exact=results.map(function(obj,index){if(obj[searchValue]===query||obj[searchValue]===val)return index}).filter(function(x){return-1<x});0<exact.length&&(results[exact[0]].selected=!0)}_this2._choices.setChoices(results,searchValue,labelValue,!0),""!==_this2._choices.input.value&&!1===isEmptyResults&&(_this2.querySelector(".".concat(config.classNames.listDropdown)).style.display="")}}else"function"==typeof paramConfig.xhrResponseErrorCallback&&paramConfig.xhrResponseErrorCallback(status,xhr)}},"function"==typeof paramConfig.xhrErrorCallback&&(xhr.onerror=paramConfig.xhrErrorCallback);var xhrQueryKey=""!==paramConfig.xhrQueryKey?paramConfig.xhrQueryKey+"=":"";if("GET"!==xhrMethod&&"get"!==xhrMethod||(apiUrl+="?".concat(xhrQueryKey+query)),xhr.open(xhrMethod,apiUrl,!0),xhr.responseType=paramConfig.xhrResponseType,Array.isArray(paramConfig.xhrHeaders))for(var x=0;x<paramConfig.xhrHeaders.length;x++){var xh=paramConfig.xhrHeaders[x];for(var h in xh)xhr.setRequestHeader(h,xh[h])}xhr.send(xhrQueryKey+query)}}},{key:"_searchEvent",value:function(){clearTimeout(this._lookupTimeout),this._lookupTimeout=setTimeout(this._serverLookup,paramConfig.lookupDelay)}},{key:"_choiceEvent",value:function(e){this._choices.clearChoices()}},{key:"_searchButtonClick",value:function(e){e&&e.preventDefault&&e.preventDefault(),"function"==typeof paramConfig.searchButtonClickCallback&&paramConfig.searchButtonClickCallback(e)}},{key:"_clearButtonClick",value:function(e){e&&e.preventDefault&&e.preventDefault();var event=new Event("beforeClearAll");this.dispatchEvent(event),this.removeChoices()}},{key:"_addItemEvent",value:function(e){this.querySelector('[data-hook="DynamicChoices-clear"]').style="display:block;",this._choices.hideDropdown(!0),"function"==typeof paramConfig.addChoiceCallback?paramConfig.addChoiceCallback(this.getChoices(!0)):this._searchButtonClick()}},{key:"_removeItemEvent",value:function(e){0===this.getChoices(!0).length&&(this.querySelector('[data-hook="DynamicChoices-clear"]').style="display:none;"),"function"==typeof paramConfig.removeItemCallback&&paramConfig.removeItemCallback()}},{key:"addChoice",value:function(paramObj){if(paramObj&&paramObj.hasOwnProperty("value")){var val=paramObj.value;if(paramObj.hasOwnProperty("removeAll")&&!0===paramObj.removeAll)this._choices.removeActiveItems();else{var obj=this.getChoices().find(function(c){return c.label===val});obj&&this._choices.removeActiveItemsByValue(obj.value)}this._serverLookup(val)}}},{key:"removeChoices",value:function(){this._choices.removeActiveItems()}},{key:"removeChoiceByValue",value:function(val){this._choices.removeActiveItemsByValue(val)}},{key:"getChoices",value:function(arrayOnly){return this._choices.getValue(arrayOnly||!1)}}]),DynamicChoices}();return window.customElements.define("dynamic-choices",DynamicChoices),document.querySelector("dynamic-choices")}